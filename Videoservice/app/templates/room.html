<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room: {{ room_name }}</title>
    <style>
        #videos {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        video {
            width: 300px;
            height: auto;
            border: 2px solid black;
            border-radius: 5px;
        }
        #chatBox {
            border: 1px solid black;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Room: {{ room_name }}</h1>
    <div id="videos">
        <video id="localVideo" autoplay playsinline muted></video>
    </div>
    <input type="text" id="chatInput" placeholder="Type a message and press Enter">
    <div id="chatBox"></div>

    <script>
        const roomName = "{{ room_name }}";
        const userId = Math.random().toString(36).substring(2, 8);
        const signalingServer = `ws://localhost:8000/ws/${roomName}/${userId}`;
        let ws;
        let localStream;
        let peerConnections = {};
        const existingUsers = new Set();
        const configuration = {
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        };

        // Clean up function to handle page refresh/close
        window.onbeforeunload = () => {
            // Close all peer connections
            Object.values(peerConnections).forEach(pc => pc.close());
            // Close WebSocket connection
            if (ws) ws.close();
            // Stop all tracks in local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
        };

        function connectWebSocket() {
            ws = new WebSocket(signalingServer);

            ws.onopen = () => {
                console.log("Connected to signaling server");
                startCall();
            };

            ws.onclose = () => {
                console.log("WebSocket connection closed. Attempting to reconnect...");
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error("WebSocket error:", error);
            };
        }

        function displayMessage(from, message, timestamp = null) {
            const chatBox = document.getElementById("chatBox");
            const timeStr = timestamp ? `[${timestamp}] ` : '';
            chatBox.innerHTML += `<p>${timeStr}${from}: ${message}</p>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function startCall() {
            try {
                if (!localStream) {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                    const localVideo = document.getElementById("localVideo");
                    localVideo.srcObject = localStream;
                }

                ws.onmessage = async (message) => {
                    const data = JSON.parse(message.data);
                    const { type, from, to, offer, answer, candidate, message: chatMessage, messages, timestamp } = data;

                    // Ignore messages from self
                    if (from === userId) return;

                    switch (type) {
                        case "offer":
                            if (!peerConnections[from]) {
                                const pc = await createPeerConnection(from);
                                await pc.setRemoteDescription(new RTCSessionDescription(offer));
                                const answer = await pc.createAnswer();
                                await pc.setLocalDescription(answer);
                                ws.send(JSON.stringify({ type: "answer", from: userId, to: from, answer }));
                            }
                            break;

                        case "answer":
                            if (peerConnections[from]) {
                                await peerConnections[from].setRemoteDescription(new RTCSessionDescription(answer));
                            }
                            break;

                        case "ice-candidate":
                            if (peerConnections[from]) {
                                await peerConnections[from].addIceCandidate(new RTCIceCandidate(candidate));
                            }
                            break;

                        case "chat-message":
                            displayMessage(from, chatMessage, timestamp);
                            break;

                        case "new-user":
                            if (!peerConnections[from]) {
                                const pc = await createPeerConnection(from);
                                const offer = await pc.createOffer();
                                await pc.setLocalDescription(offer);
                                ws.send(JSON.stringify({ type: "offer", from: userId, to: from, offer }));
                            }
                            break;
                        
                        case "chat-history":
                            document.getElementById("chatBox").innerHTML = "";
                                // Display all messages from history
                                messages.forEach(msg => {
                                    displayMessage(msg.from, msg.message, msg.timestamp);
                                });
                                break;

                        case "user-disconnected":
                            removeVideo(`remote-${from}`);
                            if (peerConnections[from]) {
                                peerConnections[from].close();
                                delete peerConnections[from];
                            }
                            existingUsers.delete(from);
                            break;
                    }
                };

                // Notify others of your presence
                ws.send(JSON.stringify({ type: "new-user", from: userId }));
            } catch (error) {
                console.error("Error in startCall:", error);
            }
        }

        async function createPeerConnection(remoteUserId) {
            const pc = new RTCPeerConnection(configuration);
            peerConnections[remoteUserId] = pc;

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: "ice-candidate",
                        from: userId,
                        to: remoteUserId,
                        candidate: event.candidate
                    }));
                }
            };

            pc.ontrack = (event) => {
                if (!existingUsers.has(remoteUserId)) {
                    addVideoStream(event.streams[0], `remote-${remoteUserId}`);
                    existingUsers.add(remoteUserId);
                }
            };

            // Add local tracks to the connection
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            
            return pc;
        }

        function addVideoStream(stream, id) {
            removeVideo(id); // Remove any existing video element with the same ID
            const videoElement = document.createElement("video");
            videoElement.id = id;
            videoElement.autoplay = true;
            videoElement.playsinline = true;
            videoElement.srcObject = stream;
            document.getElementById("videos").appendChild(videoElement);
        }

        function removeVideo(id) {
            const videoElement = document.getElementById(id);
            if (videoElement) {
                videoElement.srcObject = null;
                videoElement.remove();
            }
        }
        document.getElementById("chatInput").addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                const chatMessage = event.target.value.trim();
                if (chatMessage) {
                    const messageData = {
                        type: "chat-message",
                        from: userId,
                        message: chatMessage,
                        timestamp: new Date().toLocaleTimeString()
                    };
                    // Display message immediately
                    displayMessage(userId, chatMessage, messageData.timestamp);
                    // Send to others
                    ws.send(JSON.stringify(messageData));
                    event.target.value = "";
                }
            }
        });

        // Start the WebSocket connection
        connectWebSocket();
    </script>
</body>
</html>